function formatAMPM(e){var t=e.getHours(),r=e.getMinutes(),n=t>=12?"PM":"AM";return t%=12,t=t||12,r=r<10?"0"+r:r,t+":"+r+" "+n}function insertChat(e,t,r,n){r=r,n=n;var s,o="";s=0==n?formatAMPM(new Date):"some time ago",o="me"==e?'<li style="width:100%"><div class="msj macro"><div class="text text-l"><p><span style=\'color:#000099;\'>Me: </span>'+t+"</p><p><small>"+s+"</small></p></div></div></li>":"bot"==e?'<li style="width:100%"><div class="msj-rta macro msj-bot"><div class="text text-r"><p style="color:#8a4504;"><span style=\'color:#8a4504;\'>OdinBot: </span>'+t+"</p><p><small>"+s+"</small></p></div></div></li>":'<li style="width:100%;"><div class="msj-rta macro"><div class="text text-r"><p><span style=\'color:#006600;\'>'+currentUser.partner.attributes.name+"</span>: "+t+"</p><p><small>"+s+"</small></p></div></li>",setTimeout(function(){$("#chat-screen").append(o),chatWindow.scrollToBottom()},r)}function resetChat(){$("ul").empty()}_.templateSettings={interpolate:/\{\{\=(.+?)\}\}/g,evaluate:/\{\{(.+?)\}\}/g};var CardUser,cardUser,ChatWindow,chatWindow,SearchPeopleBar,searchPeopleBar,user,currentUser,User,users,Users;$(document).ready(function(){CardUser=Backbone.View.extend({el:"#people",template:_.template($("#card-user-template").html()),initialize:function(){this.render()},render:function(){console.log(users),this.$el.append(this.template({users:users.models}))}}),ChatWindow=Backbone.View.extend({el:"#chat-window",events:{"keypress #userInput":"send"},template:_.template($("#chat-window-template").html()),render:function(){var e={partner:currentUser.partner,current_user:currentUser};this.$el.html(this.template({data:e}))},send:function(e){if("OdinBot"==currentUser.partner.attributes.name){if(13==e.which){console.log("enter is pressed,chatting with bot");var t=$(e.currentTarget).val();insertChat("me",t),$(e.currentTarget).val(""),$(e.currentTarget).val(""),$.ajax({type:"POST",url:"/messages/bot_reply",data:{message:t},success:function(){console.log("successfully send the message to messages#bot_reply")}})}}else if(13==e.which){console.log("enter is pressed");var t=$(e.currentTarget).val();insertChat("me",t),$(e.currentTarget).val(""),$.ajax({type:"POST",url:"/messages",data:{message:t,partner_id:currentUser.partner.attributes.id},success:function(){console.log("successfully send the message")}})}},scrollToBottom:function(){var e=$("#chat-window .frame")[0];e.scrollTop=e.scrollHeight-e.clientHeight}}),chatWindow=new ChatWindow,SearchPeopleBar=Backbone.View.extend({el:"#search-people",events:{"keyup #search-people-input":"scrollToPeople"},scrollToPeople:function(){_.each($(".card-user-bio h4"),function(e){""!=$("#search-people-input").val()&&$(e).text().match(new RegExp("^"+$("#search-people-input").val()+".*"))&&(console.log("matched found"+$(e).text()),$("#people")[0].scrollTop=$(e).parent().parent().position().top)})}}),searchPeopleBar=new SearchPeopleBar,User=Backbone.Model.extend({}),currentUser=new User,currentUser.attributes=$("#current-user").data("value"),Users=Backbone.Collection.extend({model:User}),users=new Users,users.add($("#users").data("value")),cardUser=new CardUser,App.cable.subscriptions.subscriptions.find(function(e){return"global"==JSON.parse(e.identifier).group_id})==undefined&&App.cable.subscriptions.create({channel:"RoomChannel",group_id:"global"},{connected:function(){},disconnected:function(){},received:function(e){console.log(e.user_id+" is online");var t=$('h4[data-user-id="'+e.user_id+'"]');t.next().text("online"),t.next().css("color","#69d92e")}}),$.ajax({type:"get",url:"/broadcast",complete:function(){console.log("get request to sessions#broadcast_from_client")}});var e={};$(".user-btn").on("click",function(t){$("#search-people-input").val(""),t.preventDefault(),currentUser.partner=users.get(parseInt($(t.currentTarget).data("person")));var r=currentUser.partner;chatWindow.render(),$.ajax({type:"GET",url:"/messages/all_messages_in_particular_group",data:{partner_id:currentUser.partner.attributes.id},success:function(t){t[0]&&_.each(t,function(e){e.user_id==currentUser.attributes.id?insertChat("me",e.content,0,!0):insertChat("partner",e.content,0,!0)}),e[t.id||t[0].group_id]&&(clearInterval(e[t.id||t[0].group_id]),console.log(JSON.stringify(e)+"cleared interval. resp: "+(t.id||t[0].group_id)),e[t.id||t[0].group_id]=null,console.log("partner for this grp:"+r),$('h4[data-user-id="'+r.attributes.id+'"]').css({color:"inherit"})),App.cable.subscriptions.subscriptions.find(function(e){return JSON.parse(e.identifier).group_id==(t.id||t[0].group_id)})==undefined&&(App.room=App.cable.subscriptions.create({channel:"RoomChannel",group_id:t.id||t[0].group_id},{connected:function(){console.log("connected from group "+(t.id||t[0].group_id))},disconnected:function(){console.log("disconnected from group "+(t.id||t[0].group_id))},received:function(n){console.log("received"+n),n.user_id!==currentUser.attributes.id&&currentUser.partner.attributes.id==n.user_id&&insertChat("partner",n.content),currentUser.partner.attributes.id!==r.attributes.id&&(console.log("notification from partner "+r.attributes.name),insertChat("bot","There is a message from "+r.attributes.name),e[t.id||t[0].group_id]=setInterval(function(){var e=$('h4[data-user-id="'+r.attributes.id+'"]');"rgb(255, 0, 0)"==e.css("color")?e.css("color","inherit"):e.css("color","rgb(255, 0, 0)")},300),console.log("blinking hash added: "+JSON.stringify(e)))}}))}})}),$(".bot-btn").on("click",function(){$("#search-people-input").val(""),currentUser.partner=new User({name:"OdinBot"});var t=currentUser.partner;chatWindow.render(),console.log("clicked to bot"),e["bot_human_"+currentUser.attributes.id]&&(clearInterval(e["bot_human_"+currentUser.attributes.id]),console.log(JSON.stringify(e)+"cleared interval. bot_human_"+currentUser.attributes.id),e["bot_human_"+currentUser.attributes.id]=null,console.log("partner for this grp:"+t),$("#bot-label-name").css({color:"inherit"})),App.cable.subscriptions.subscriptions.find(function(e){return JSON.parse(e.identifier).bot_human_id==currentUser.attributes.id})==undefined&&(console.log("subscription created for bot_human_"),App.room=App.cable.subscriptions.create({channel:"RoomChannel",bot_human_id:currentUser.attributes.id},{connected:function(){console.log("connected from bot-human group "+currentUser.attributes.id)},disconnected:function(){console.log("disconnected bot-human from group "+currentUser.attributes.id)},received:function(r){console.log("received"+r),setTimeout(function(){insertChat("partner(bot)",r.content)},4*Math.random()*1e3),currentUser.partner.attributes.name!==t.attributes.name&&(console.log("notification from partner "+t.attributes.name),insertChat("bot","There is a message from "+t.attributes.name),e["bot_human_"+currentUser.attributes.id]=setInterval(function(){var e=$("#bot-label-name");"rgb(255, 0, 0)"==e.css("color")?e.css("color","inherit"):e.css("color","rgb(255, 0, 0)")},300),console.log("blinking hash added: "+JSON.stringify(e)))}}))})}),resetChat();